apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
kubernetesVersion: v{{KUBERNETES_VERSION}}
controlPlaneEndpoint: "{{hostvars[ groups['lb'][0] ]['inventory_hostname']}}:6443"
etcd:
    local:
        serverCertSANs:
            - {{inventory_hostname}}
            - {{ansible_fqdn}}
            - {{ansible_hostname}}
        peerCertSANs:
            - {{inventory_hostname}}
            - {{ansible_fqdn}}
            - {{ansible_hostname}}
        extraArgs:
            initial-cluster: {% for host in groups['etcd'] %}{{hostvars[host]['ansible_hostname']}}=https://{{hostvars[host]['inventory_hostname']}}:2380{% if not loop.last %},{% endif %}{% endfor %}

            initial-cluster-state: new
            name: {{ansible_hostname}}
            listen-peer-urls: https://{{inventory_hostname}}:2380
            listen-client-urls: https://{{inventory_hostname}}:2379
            advertise-client-urls: https://{{inventory_hostname}}:2379
            initial-advertise-peer-urls: https://{{inventory_hostname}}:2380
networking:
  serviceSubnet: "10.96.0.0/12"
  podSubnet: "10.100.0.1/24"
  dnsDomain: "{{CLUSTER_DOMAIN}}"
apiServer:
  extraArgs:
    authorization-mode: "Node,RBAC"
    apiserver-count: "{{ groups['masters'] | length }}"
    feature-gates: "TTLAfterFinished=true"
    audit-log-path: "/var/log/kubernetes/audit"
    audit-log-maxage: "2"
  certSANs:
{% for host in groups['masters'] %}
  - {{hostvars[host]['inventory_hostname']}}
{% endfor %}
  - {{hostvars[groups['lb'][0]]['inventory_hostname']}}
  - {{APISERVER_DNS}}
  - 127.0.0.1
  timeoutForControlPlane: 4m0s
controllerManager:
  extraArgs:
    feature-gates: "TTLAfterFinished=true"
scheduler:
  extraArgs:
    feature-gates: "TTLAfterFinished=true"
clusterName: "{{CLUSTER_NAME}}"
---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
authentication:
  anonymous:
    enabled: false
  webhook:
    enabled: true
cgroupDriver: systemd
clusterDomain: {{CLUSTER_DOMAIN}}
containerLogMaxFiles: 5
containerLogMaxSize: 10Mi
evictionHard:
  imagefs.available: 15%
  memory.available: 512Mi
  nodefs.available: 10%
  nodefs.inodesFree: 10%
systemReserved:
  cpu: 250m
  memory: 150Mi
kubeReserved:
  cpu: 250m
  memory: 50Mi
evictionPressureTransitionPeriod: 5m0s
maxOpenFiles: 1000000
maxPods: 110
oomScoreAdj: -999
podPidsLimit: -1